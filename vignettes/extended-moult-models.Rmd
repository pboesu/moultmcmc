---
title: "Extended moult models"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Extended moult models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: moultmcmc.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

To install `moultmcmc` please follow the instructions in the [README file](https://github.com/pboesu/moultmcmc#installation).

```{r setup, warning=FALSE, message=FALSE}
library(moult)
library(moultmcmc)
library(dplyr)
library(ggplot2)
library(rstan)
```

# Lumped models

# Mixed moult data

# Repeated measures moult models 
When the assumption of even sampling among and within moult categories is violated, the standard moult model can converge at biologically non-sensible results. 

This problem can be greatly reduced when information about the pace of moult from within-season recaptures of individuals is explicitly incorporated into to the parameter estimation using the model.

The repeated measures model is currently implemented for data types 2, 3 and 5 in the `moultmcmc` function. The repeated measures model is triggered by supplying the optional argument `id_column` which designates *within season* recaptures, typically formed of a combination of ring number and season.

We demonstrate this here using a citizen science dataset of moult scores from Eurasian Siskins (*Spinus spinus*) which is biased towards records of birds in the early stages of moult (@insley2022moult).


```{r siskin-hist, fig.width = 7, fig.cap='Frequency distribution of moult records with respect to moult progress for actively moulting Eurasian Siskins [@insley2022moult] sampled in a sub-urban garden in Scotland (left) and seasonal progression of observed moult scores from the same dataset (right). Lines connect repeated observations of the same individuals.', echo= FALSE, message = FALSE, fig.height = 3}
data(siskins)
cowplot::plot_grid(
ggplot(filter(siskins, pfmg > 0), aes(x=pfmg)) +
  geom_histogram(breaks = c(0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1)) +
  theme_classic() + xlab("Moult index") + ylab("Number of records"),
ggplot(siskins, aes(x=yday,y=pfmg,group=id)) +
  geom_point(alpha = 0.3) + geom_path(alpha = 0.5)+
  theme_classic() + xlab('Days since Jan 01') + ylab('PFMG'))
```

The standard models are fitted using the `moult` package
```{r siskin-models}
#fit standard Underhill-Zucchini models
m3 <- moult(pfmg ~ yday, data = siskins, type = 3)
m5 <- moult(pfmg ~ yday, data = siskins, type = 5)
```

```{r, echo = FALSE}
# strangely the bayesian simple model appears to be largely unaffected by the bias??
# Is this because of the somewhat informative prior on the sd?
# recap model still features better precision on estimates though (nominal..., check coverage)
uz3 <- moultmcmc('pfmg',
                  'yday',
                  start_formula = ~1,
                  duration_formula = ~1,
                  log_lik = FALSE,
                  data=siskins,
                  type = 3,
                  iter = 2000,
                  chain = 2,
                  cores = 2)
uz5 <- moultmcmc('pfmg',
                  'yday',
                  start_formula = ~1,
                  duration_formula = ~1,
                  log_lik = FALSE,
                  data=siskins,
                  type = 5,
                  iter = 2000,
                  chain = 2,
                  cores = 2)

```

and the repeated measures models with `moultmcmc`

```{r sisikin-recap-models, cache = TRUE, warning=FALSE}
#fit the equivalent recapture model
uz3_recap <- moultmcmc(moult_column = 'pfmg',
                       date_column = 'yday',
                       id_column = 'id',
                       start_formula = ~1,
                       duration_formula = ~1,
                       type = 3,
                       log_lik = FALSE,
                       data=siskins,
                       iter = 1000,
                       chain = 2,
                       cores = 2)
max(rowSums(get_elapsed_time(uz3_recap$stanfit)))
uz5_recap <- moultmcmc('pfmg',
                       'yday',
                       'id',
                       start_formula = ~1,
                       duration_formula = ~1,
                       type = 5,
                       log_lik = FALSE,
                       data=siskins,
                       iter = 1000,
                       chain = 2,
                       cores = 2)
max(rowSums(get_elapsed_time(uz5_recap$stanfit)))

```
When comparing the results visually it is apparent that the moult period for the population predicted by the standard models fails to encapsulate a substantial proportion of the observed data (Fig. \@ref(fig:siskin-model-plots)), whereas this is not the case for the repeated measures models.

```{r siskin-model-plots, fig.width=7, echo = FALSE, fig.cap='Standard type 3 and 5 moult models fitted to the Siskin dataset without considering within-season recaptures converge at biased parameter estimates (red lines and polygons). When recapture information is included in the model, the resulting fits (green lines and polygons) better encapsulate the observed data.'}
m_summ <- bind_rows(moult_plot(m3, plot=F) %>% mutate(model = 'no recaptures ML'),
                    moult_plot(uz3, plot = F) %>% mutate(model = 'no recaptures MCMC'),
                    moult_plot(uz3_recap, plot=F) %>% mutate(model = 'recaptures'))
#hacky way to reorder data to plot polygon
filter(m_summ, line_type == '95 % quantile') %>% tidyr::pivot_longer(start_date:end_date, values_to = 'x', names_to = 'se') %>% group_by(model,se) %>% mutate(y = ifelse(se == 'start_date', 0, 1), lci = ifelse(x == min(x), 1,0)) %>% arrange(model,x) -> m_summ_poly
m3_comp <-
  ggplot(filter(siskins, pfmg > 0), aes(x = yday, y = pfmg)) + 
  geom_polygon(data = m_summ_poly[c(1, 2, 4, 3,
                                    5, 6, 8, 7,
                                    9, 10, 12, 11), ], aes(x = x, y = y, fill = model), alpha = 0.3) +
  geom_segment(
    data = filter(m_summ, line_type == 'Population mean'),
    aes(
      x = start_date,
      y = 0,
      xend = end_date,
      yend = 1,
      col = model
    ),
    lwd = 1
  )  + theme_classic() + ggtitle('Type 3 model') + geom_point(alpha = 0.4) + xlim(170,340)

m_summ <- bind_rows(moult_plot(m5, plot=F) %>% mutate(model = 'no recaptures ML'),
                    moult_plot(uz5, plot=F) %>% mutate(model = 'no recaptures MCMC'),
                    moult_plot(uz5_recap, plot=F) %>% mutate(model = 'repeated measures model'))
#hacky way to reorder data to plot polygon
filter(m_summ, line_type == '95 % quantile') %>% tidyr::pivot_longer(start_date:end_date, values_to = 'x', names_to = 'se') %>% group_by(model,se) %>% mutate(y = ifelse(se == 'start_date', 0, 1), lci = ifelse(x == min(x), 1,0)) %>% arrange(model,x) -> m_summ_poly

m5_comp <- ggplot(filter(siskins), aes(x = yday, y = pfmg)) + 
  geom_polygon(data = m_summ_poly[c(1,2,4,3,
                                    5,6,8,7,
                                    9,10,12,11),],
               aes(x = x, y = y, fill = model), alpha = 0.3 ) + 
  geom_segment(data = filter(m_summ, line_type == 'Population mean'), aes(x = start_date, y = 0, xend = end_date, yend = 1, col = model), lwd = 1)  + theme_classic() + ggtitle('Type 5 model') + geom_point(alpha = 0.4) + theme(legend.position = 'bottom') + xlim(170,340)

m5_legend <- cowplot::get_legend(m5_comp)
cowplot::plot_grid(cowplot::plot_grid(m3_comp+theme(legend.position='none')+ylab('PFMG')+xlab('Days since Jan 01'),
                   m5_comp+theme(legend.position='none')+ylab('PFMG')+xlab('Days since Jan 01')),
                                 m5_legend, nrow = 2, rel_heights =  c(1,.1))

```

```{r fig.width=7}
compare_plot(m3,uz3,uz3_recap,m5,uz5,uz5_recap)

```

# References

